<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel Aiken</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f5;
            padding: 20px;
        }

        .container {
            background: #fff;
            max-width: 1100px;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0, 0, 0, .1);
        }

        h2,
        h3 {
            text-align: center;
        }

        .panel {
            text-align: center;
            margin-bottom: 20px;
        }

        .panel button {
            background: #004aad;
            margin: 6px;
        }

        .panel button:hover {
            background: #0066ff;
        }

        .section {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        textarea {
            width: 100%;
            height: 180px;
            margin-top: 10px;
        }

        button {
            margin: 6px;
            padding: 10px 18px;
            background: rgb(0, 101, 0);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background: rgb(0, 207, 0);
        }

        .reset {
            background: rgb(255, 89, 89);
        }

        .reset:hover {
            background: rgb(255, 0, 0);
        }

        .stats {
            font-weight: bold;
            margin-top: 8px;
        }

        .modulo {
            display: none;
        }

        .dropzone {
            border: 2px dashed #004aad;
            padding: 20px;
            text-align: center;
            color: #004aad;
            font-weight: bold;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #f4f8ff;
        }

        .dropzone:hover {
            background: #e6f0ff;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>ğŸ“š Panel Aiken Unificado</h2>

        <!-- PANEL -->
        <div class="panel">
            <button onclick="mostrar('pf')">ğŸ“˜ Parcial / Final</button>
            <button onclick="mostrar('comp')">ğŸ” Comparador</button>
            <button onclick="mostrar('multi')">ğŸ“‚ Multi-Archivos</button>
        </div>
        <!-- ================= PARCIAL / FINAL ================= -->
        <div id="pf" class="modulo">

            <h3>ğŸ“˜ Parcial / Final</h3>

            <div class="section">
                <h3>ğŸ“˜ Examen Parcial</h3>

                <div class="dropzone" onclick="document.getElementById('pf_parcial').click()"
                    ondragover="dragOver(event)" ondrop="dropPF(event, 'parcial')">

                    ğŸ“¥ Arrastra aquÃ­ uno o varios archivos TXT del Parcial<br>
                    o haz clic para seleccionar
                </div>

                <input type="file" id="pf_parcial" multiple accept=".txt" style="display:none">

                <br>
                <button onclick="pfProcesar('parcial')">âš™ Procesar Parcial</button>
                <button onclick="descargarTexto(pf_data.parcial,'EP.txt')">â¬‡ Descargar Parcial</button>

                <textarea id="pf_out_parcial"></textarea>
                <div class="stats" id="pf_stats_parcial"></div>

                <h4>ğŸ§© Duplicados Parcial</h4>
                <textarea id="dup_pf_parcial" readonly></textarea>
                <p id="cnt_pf_parcial"></p>
            </div>


            <div class="section">
                <h3>ğŸ“• Examen Final</h3>

                <div class="dropzone" onclick="document.getElementById('pf_final').click()" ondragover="dragOver(event)"
                    ondrop="dropPF(event, 'final')">

                    ğŸ“¥ Arrastra aquÃ­ uno o varios archivos TXT del Final<br>
                    o haz clic para seleccionar
                </div>

                <input type="file" id="pf_final" multiple accept=".txt" style="display:none">

                <br>
                <button onclick="pfProcesar('final')">âš™ Procesar Final</button>
                <button onclick="descargarTexto(pf_data.final,'EF.txt')">â¬‡ Descargar Final</button>

                <textarea id="pf_out_final"></textarea>
                <div class="stats" id="pf_stats_final"></div>

                <h4>ğŸ§© Duplicados Final</h4>
                <textarea id="dup_pf_final" readonly></textarea>
                <p id="cnt_pf_final"></p>
            </div>


            <div class="section">
                <button onclick="pfUnir()">ğŸ”¥ Unir y Depurar</button>
                <button onclick="descargarTexto(pf_data.union,'RECUPERACIÃ“N.txt')">â¬‡ Descargar UniÃ³n</button>

                <textarea id="pf_out_union"></textarea>
                <div class="stats" id="pf_stats_union"></div>

                <h4>ğŸ§© Duplicados UniÃ³n</h4>
                <textarea id="dup_pf_union" readonly></textarea>
                <p id="cnt_pf_union"></p>

            </div>

            <button class="reset" onclick="pfLimpiar()">ğŸ§¹ Limpiar</button>
        </div>


        <!-- ================= COMPARADOR ================= -->
        <div id="comp" class="modulo">

            <h3>ğŸ” Comparador Aiken</h3>

            <div class="section">
                <h3>ğŸ“˜ Archivo Principal (Referencia)</h3>
                <input type="file" id="c_principal">
                <textarea id="c_txt_principal"></textarea>
            </div>

            <div class="section">
                <h3>ğŸ“„ Archivo a Comparar</h3>
                <input type="file" id="c_comparar">
                <textarea id="c_txt_comparar"></textarea>
            </div>

            <div class="section">
                <button onclick="comparar()">ğŸ” Comparar</button>
                <button onclick="descargarTexto(comp_resultado,'no_encontradas.txt')">â¬‡ Descargar Resultado</button>
                <textarea id="c_resultado"></textarea>
                <div class="stats" id="c_stats"></div>
            </div>

            <button class="reset" onclick="compLimpiar()">Limpiar</button>
        </div>

        <!-- ================= MULTI ARCHIVOS ================= -->
        <div id="multi" class="modulo">

            <h3>ğŸ“‚ Multi-Archivos</h3>

            <div class="section">
                <h4>ğŸ“¥ Arrastra aquÃ­ los archivos TXT</h4>
                <div id="dropZone" onclick="document.getElementById('m_files').click()" ondragover="dragOver(event)"
                    ondrop="dropMulti(event)" style="border:2px dashed #004aad; padding:20px; text-align:center;
            font-weight:bold; border-radius:6px; background:#f4f8ff;">
                    Arrastra uno o varios archivos .txt aquÃ­<br>
                    o haz clic para seleccionar
                </div>

                <input type="file" id="m_files" multiple accept=".txt" style="display:none">
                <p id="m_info"></p>
            </div>

            <div class="section">
                <button onclick="procesarMulti()">âš™ Procesar</button>
                <button onclick="descargarTexto(m_resultado,'aiken_unificado.txt')">â¬‡ Descargar Resultado</button>
                <textarea id="m_out"></textarea>
                <div class="stats" id="m_stats"></div>

                <h4>ğŸ§© Duplicados Multi</h4>
                <textarea id="dup_multi" readonly></textarea>
                <p id="cnt_multi"></p>

            </div>

            <button class="reset" onclick="multiLimpiar()">Limpiar</button>
        </div>

    </div>

    <script>

        let pfFiles = {
            parcial: [],
            final: []
        };

        /* ================= ESTADO GLOBAL ================= */

        let pf_files = { parcial: [], final: [] };
        let pf_data = { parcial: "", final: "", union: "" };

        let multiFiles = [];
        let m_resultado = "";

        /* ================= UTILIDADES ================= */

        function normalizarTexto(txt) {
            return txt
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9]/g, "")
                .trim();
        }

        function limpiarEspacios(txt) {
            return txt
                .replace(/\s+/g, " ")
                .replace(/\s+\./g, ".")
                .replace(/\s+,/g, ",")
                .trim();
        }

        /* ================= PARSER AIKEN SEGURO ================= */

        function parsearAikenSeguro(texto) {
            const lineas = texto
                .replace(/\t+/g, " ")
                .split("\n")
                .map(l => l.trim())
                .filter(l => l.length > 0);

            const bloques = [];
            let i = 0;

            while (i < lineas.length) {

                const pregunta = limpiarEspacios(lineas[i]);
                i++;

                const opciones = [];
                while (
                    i < lineas.length &&
                    /^[A-E]\.\s*/i.test(lineas[i]) &&
                    opciones.length < 5
                ) {
                    opciones.push(limpiarEspacios(lineas[i]));
                    i++;
                }

                if (opciones.length !== 5) continue;
                if (i >= lineas.length || !/^ANSWER:\s*[A-E]$/i.test(lineas[i])) continue;

                const answer = lineas[i];
                i++;

                bloques.push([
                    pregunta,
                    ...opciones,
                    answer
                ].join("\n"));
            }

            return bloques;
        }

        /* ================= DUPLICADOS ================= */

        function eliminarDuplicados(bloques) {
            const vistos = new Map();
            const unicos = [];
            const duplicados = [];

            for (const bloque of bloques) {
                const l = bloque.split("\n");

                const clave =
                    normalizarTexto(l[0]) +
                    l.slice(1, 6).map(normalizarTexto).join("");

                if (vistos.has(clave)) {
                    duplicados.push(bloque);
                } else {
                    vistos.set(clave, true);
                    unicos.push(bloque);
                }
            }

            return {
                total: bloques.length,
                unicos: unicos.length,
                repetidos: duplicados.length,
                textoFinal: unicos.join("\n\n"),
                duplicados
            };
        }

        function procesarTexto(texto) {
            return eliminarDuplicados(parsearAikenSeguro(texto));
        }

        /* ================= ARCHIVOS ================= */

        function leerP(file) {
            return new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => res(r.result);
                r.onerror = rej;
                r.readAsText(file, "UTF-8");
            });
        }

        /* ================= RESULTADOS ================= */

        function mostrarResultado(r, out, stats, dup, cnt) {
            document.getElementById(out).value = r.textoFinal;
            document.getElementById(stats).innerText =
                `Originales: ${r.total} | Ãšnicas: ${r.unicos} | Duplicadas: ${r.repetidos}`;
            document.getElementById(dup).value = r.duplicados.join("\n\n");
            document.getElementById(cnt).innerText = `Duplicados: ${r.duplicados.length}`;
        }

        function mostrarDuplicados(duplicados, areaId, contadorId) {
            const area = document.getElementById(areaId);
            const contador = document.getElementById(contadorId);

            if (!area || !contador) return;

            if (!duplicados || duplicados.length === 0) {
                area.value = "âœ… No se detectaron preguntas duplicadas.";
                contador.innerText = "";
                return;
            }

            let salida = "";

            duplicados.forEach((d, i) => {
                salida += `ğŸ”¹ DUPLICADO #${i + 1}\n`;
                salida += `ğŸ“Œ Pregunta conservada:\n${d.original}\n\n`;
                salida += `âŒ Pregunta eliminada:\n${d.repetido}\n`;
                salida += "\n----------------------------------\n\n";
            });

            area.value = salida;
            contador.innerText = `âš ï¸ Total de duplicados eliminados: ${duplicados.length}`;
        }

        /* ================= DESCARGA ================= */

        function descargarTexto(txt, nombre) {
            if (!txt) return alert("No hay contenido");
            const b = new Blob([txt], { type: "text/plain;charset=utf-8" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(b);
            a.download = nombre;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        /* ================= DRAG & DROP ================= */

        function dropPF(e, tipo) {
            e.preventDefault();
            pf_files[tipo].push(...e.dataTransfer.files);
        }

        function dropMulti(e) {
            e.preventDefault();
            multiFiles.push(...e.dataTransfer.files);
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function dropPF(e, tipo) {
            e.preventDefault();

            const files = Array.from(e.dataTransfer.files)
                .filter(f => f.name.toLowerCase().endsWith(".txt"));

            if (files.length === 0) {
                alert("Solo archivos .txt");
                return;
            }

            pfFiles[tipo] = files;

            document.getElementById(`pf_stats_${tipo}`).innerText =
                `Archivos cargados: ${files.length}`;
        }

        /* ================= PARCIAL / FINAL ================= */

        async function pfProcesar(tipo) {
            const files = pfFiles[tipo];
            if (!files || files.length === 0)
                return alert("Arrastra al menos un archivo");

            let texto = "";
            for (const f of files) {
                texto += await leerP(f) + "\n\n";
            }

            const r = procesarTexto(texto);
            pf_data[tipo] = r.textoFinal;

            document.getElementById(`pf_out_${tipo}`).value = r.textoFinal;
            document.getElementById(`pf_stats_${tipo}`).innerText =
                `Archivos: ${files.length} | Originales: ${r.total} | Ãšnicas: ${r.unicos} | Duplicadas: ${r.repetidos}`;

            mostrarDuplicados(r.duplicados, `dup_pf_${tipo}`, `cnt_pf_${tipo}`);
        }


        function pfLimpiar() {
            pf_files = { parcial: [], final: [] };
            pf_data = { parcial: "", final: "", union: "" };

            [
                "pf_out_parcial", "pf_out_final", "pf_out_union",
                "pf_stats_parcial", "pf_stats_final", "pf_stats_union",
                "dup_pf_parcial", "dup_pf_final", "dup_pf_union",
                "cnt_pf_parcial", "cnt_pf_final", "cnt_pf_union"
            ].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if ("value" in el) el.value = "";
                else el.innerText = "";
            });
        }

        function pfUnir() {
            if (!pf_data.parcial && !pf_data.final) {
                alert("No hay contenido para unir");
                return;
            }

            const textoUnido = [pf_data.parcial, pf_data.final]
                .filter(t => t && t.trim().length > 0)
                .join("\n\n");

            if (!textoUnido.trim()) {
                alert("No hay preguntas vÃ¡lidas");
                return;
            }

            const r = procesarTexto(textoUnido);

            pf_data.union = r.textoFinal;

            document.getElementById("pf_out_union").value = r.textoFinal;
            document.getElementById("pf_stats_union").innerText =
                `Originales: ${r.total} | Ãšnicas: ${r.unicos} | Duplicadas: ${r.repetidos}`;

            mostrarDuplicados(r.duplicados, "dup_pf_union", "cnt_pf_union");
        }

        /* ================= MULTI ================= */

        async function procesarMulti() {
            if (multiFiles.length === 0)
                return alert("Arrastra al menos un archivo");

            let texto = "";
            for (const f of multiFiles) {
                texto += await leerP(f) + "\n\n";
            }

            const r = procesarTexto(texto);
            m_resultado = r.textoFinal;

            m_out.value = r.textoFinal;
            m_stats.innerText =
                `Archivos: ${multiFiles.length} | Originales: ${r.total} | Ãšnicas: ${r.unicos} | Duplicadas: ${r.repetidos}`;

            mostrarDuplicados(r.duplicados, "dup_multi", "cnt_multi");
        }


        function dropMulti(e) {
            e.preventDefault();

            const files = Array.from(e.dataTransfer.files)
                .filter(f => f.name.toLowerCase().endsWith(".txt"));

            if (files.length === 0) {
                alert("Solo archivos .txt");
                return;
            }

            multiFiles = files;
            m_info.innerText = `Archivos cargados: ${files.length}`;
        }

        document.getElementById("m_files").addEventListener("change", e => {
            multiFiles = Array.from(e.target.files);
            m_info.innerText = `Archivos cargados: ${multiFiles.length}`;
        });

        function multiLimpiar() {
            multiFiles = [];
            m_resultado = "";
            m_out.value = "";
            m_stats.innerText = "";
            m_info.innerText = "";
            dup_multi.value = "";
            cnt_multi.innerText = "";
            document.getElementById("m_files").value = "";
        }


        function mostrar(id) {
            document.querySelectorAll(".modulo").forEach(m => {
                m.style.display = "none";
            });
            const panel = document.getElementById(id);
            if (panel) panel.style.display = "block";
        }
        mostrar("pf");

    </script>


</body>

</html>
